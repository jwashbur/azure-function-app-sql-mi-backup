<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
<script>
  const progressBar = document.getElementById('progress-bar');
  const statusMsg = document.getElementById('status');

  async function connectToSignalR() {
    const res = await fetch('/api/negotiate');
    const info = await res.json();

    const connection = new signalR.HubConnectionBuilder()
      .withUrl(info.url, { accessTokenFactory: () => info.accessToken })
      .configureLogging(signalR.LogLevel.Information)
      .build();

    connection.on("backupStatus", (msg) => {
      if (msg.status === "started") {
        progressBar.style.width = "0%";
        statusMsg.textContent = "🔄 Backup started...";
      } else if (msg.status === "progress") {
        const percent = msg.percent || 50;
        progressBar.style.width = percent + "%";
        statusMsg.textContent = `⏳ Backup progress: ${percent}%`;
      } else if (msg.status === "complete") {
        progressBar.style.width = "100%";
        statusMsg.textContent = "✅ Backup completed!";
      }
    });

    await connection.start();
    console.log("SignalR connected.");
  }

  document.getElementById('btn').onclick = async () => {
    statusMsg.textContent = "Calling backup...";
    await connectToSignalR();
    await fetch('/api/trigger-backup', { method: 'POST' });
  };
</script>
